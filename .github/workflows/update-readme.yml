name: Update README

on:
  push:
    paths:
      - 'profiles/**/Brewfile'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Count packages
        id: count
        run: |
          BREWFILE="profiles/default/Brewfile"
          if [ ! -f "$BREWFILE" ]; then
            echo "No Brewfile found"
            exit 0
          fi
          TAPS=$(grep -c "^tap " "$BREWFILE" || echo 0)
          BREWS=$(grep -c "^brew " "$BREWFILE" || echo 0)
          CASKS=$(grep -c "^cask " "$BREWFILE" || echo 0)
          MAS=$(grep -c "^mas " "$BREWFILE" || echo 0)
          TOTAL=$((TAPS + BREWS + CASKS + MAS))
          echo "taps=$TAPS" >> "$GITHUB_OUTPUT"
          echo "brews=$BREWS" >> "$GITHUB_OUTPUT"
          echo "casks=$CASKS" >> "$GITHUB_OUTPUT"
          echo "mas=$MAS" >> "$GITHUB_OUTPUT"
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"

      - name: Get device info
        id: devices
        run: |
          TABLE=""
          for dir in profiles/*/; do
            profile=$(basename "$dir")
            # Find latest Brewfile commit
            LAST_DATE=$(git log -1 --format="%cs" -- "${dir}Brewfile" 2>/dev/null || echo "unknown")
            LAST_MSG=$(git log -1 --format="%s" -- "${dir}Brewfile" 2>/dev/null || echo "")
            # Extract device name from commit message
            DEVICE=$(echo "$LAST_MSG" | sed -n "s/.*from \(.*\) [-(].*/\1/p" | sed 's/ *$//')
            [ -z "$DEVICE" ] && DEVICE=$(echo "$LAST_MSG" | sed -n "s/.*from \(.*\)/\1/p" | sed 's/ *$//')
            [ -z "$DEVICE" ] && DEVICE="unknown"
            TABLE="${TABLE}| ${DEVICE} | ${LAST_DATE} | ${profile} |\n"
          done
          echo "table<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$TABLE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Update README
        run: |
          cat > README.md << 'HEADER'
          # ğŸº brew-backup

          æˆ‘çš„ Homebrew è½¯ä»¶åŒ…å¤‡ä»½ï¼Œç”± [brew-sync](https://github.com/kyungw00k/brew-sync) ç®¡ç†ã€‚

          ## å½“å‰é…ç½®
          HEADER

          # Remove leading spaces from heredoc
          sed -i 's/^          //' README.md

          cat >> README.md << EOF

          | ç±»å‹ | æ•°é‡ |
          |------|------|
          | Tap | ${{ steps.count.outputs.taps }} |
          | Formula | ${{ steps.count.outputs.brews }} |
          | Cask | ${{ steps.count.outputs.casks }} |
          | **æ€»è®¡** | **${{ steps.count.outputs.total }}** |

          ## å¿«é€Ÿå¼€å§‹

          ### 1. å®‰è£… brew-sync

          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/kyungw00k/brew-sync/main/install.sh | bash
          \`\`\`

          ### 2. å…‹éš†å¹¶æ¢å¤

          \`\`\`bash
          git clone https://github.com/gandli/brew-backup ~/.brew-sync-git

          # é…ç½®å­˜å‚¨
          mkdir -p ~/.config/brew-sync
          cat > ~/.config/brew-sync/last_storage << 'CONF'
          method=git
          path="\$HOME/.brew-sync-git"
          CONF
          echo "default" > ~/.config/brew-sync/default_profile

          # æ¢å¤
          brew-sync restore
          \`\`\`

          > ğŸ’¡ ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ Brewfileï¼š
          > \`\`\`bash
          > cd ~/.brew-sync-git/profiles/default && brew bundle install
          > \`\`\`

          ## æ—¥å¸¸ä½¿ç”¨

          \`\`\`bash
          # å¤‡ä»½
          brew-sync backup

          # æ¢å¤ï¼ˆå…ˆé¢„è§ˆå†æ‰§è¡Œï¼‰
          brew-sync restore --dry-run
          brew-sync restore

          # æŸ¥çœ‹çŠ¶æ€ / å†å²
          brew-sync status
          brew-sync history

          # å›æ»šåˆ°å†å²ç‰ˆæœ¬
          brew-sync rollback

          # ç¼–è¾‘è½¯ä»¶åŒ…åˆ—è¡¨
          brew-sync edit
          \`\`\`

          ## è®¾å¤‡

          | è®¾å¤‡ | æœ€åå¤‡ä»½ | é…ç½® |
          |------|----------|------|
          ${{ steps.devices.outputs.table }}

          ---

          Powered by [brew-sync](https://github.com/kyungw00k/brew-sync) Â· MIT License
          EOF

          sed -i 's/^          //' README.md

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git diff --quiet README.md && echo "No changes" && exit 0
          git add README.md
          git commit -m "docs: auto-update README [skip ci]"
          git push
